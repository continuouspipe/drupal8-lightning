tasks:
    images:
        build:
            environment:
                - name: GITHUB_TOKEN
                  value: ${GITHUB_TOKEN}

            services:
                web:
                    image: quay.io/inviqa_images/drupal7

    deployment:
        deploy:
            cluster: ${CLUSTER}
            environment:
                name: '"drupal7demo-" ~ code_reference.branch'

            services:
                database:
                    specification:
                        volumes:
                            - type: persistent
                              name: database-volume
                              capacity: 5Gi
                              storage_class: default

                        volume_mounts:
                            - name: database-volume
                              mount_path: /var/lib/mysql

                        command:
                            - /usr/local/bin/docker-entrypoint.sh
                            - mysqld
                            - --ignore-db-dir=lost+found
                            - --max_allowed_packet=128M

                        ports:
                            - 3306

                        resources:
                            requests:
                                cpu: 50m
                                memory: 250Mi

                            limits:
                                cpu: 500m
                                memory: 2Gi

                    deployment_strategy:
                        readiness_probe:
                            type: tcp
                            port: 3306

                varnish:
                    endpoints:
                        -
                            name: http

                    specification:
                        ports:
                            - 80

                        resources:
                            limits:
                                cpu: 50m
                                memory: 500Mi

                    deployment_strategy:
                        readiness_probe:
                            type: tcp
                            port: 80

                web:
                    specification:
                        environment_variables:
                            - name: GITHUB_TOKEN
                              value: ${GITHUB_TOKEN}
                            - name: APP_USER_LOCAL
                              value: false
                            - name: DRUPAL_HASH_SALT
                              value: ${DRUPAL_HASH_SALT}
                            - name: DRUPAL_DATABASE_NAME
                              value: ${DRUPAL_DATABASE_NAME}
                            - name: DRUPAL_DATABASE_USERNAME
                              value: ${DRUPAL_DATABASE_USERNAME}
                            - name: DRUPAL_DATABASE_PASSWORD
                              value: ${DRUPAL_DATABASE_PASSWORD}
                            - name: DRUPAL_DATABASE_PREFIX
                              value: ${DRUPAL_DATABASE_PREFIX}
                            - name: DRUPAL_DATABASE_HOST
                              value: ${DRUPAL_DATABASE_HOST}
                            - name: DRUPAL_DATABASE_PORT
                              value: ${DRUPAL_DATABASE_PORT}
                            - name: DRUPAL_CONFIG_DIRECTORY_SECRET
                              value: ${DRUPAL_CONFIG_DIRECTORY_SECRET}

                        ports:
                            - 80

                        resources:
                            requests:
                                cpu: 50m
                                memory: 500Mi

                            limits:
                                cpu: 1
                                memory: 2G


                    deployment_strategy:
                        readiness_probe:
                            type: tcp
                            port: 80

                solr:
                    specification:
                        volumes:
                            - type: persistent
                              name: solr-volume
                              capacity: 5Gi
                              storage_class: default
                        volume_mounts:
                            - name: solr-volume
                              mount_path: /usr/local/share/solr/d8/data/

                        ports:
                            - 8983

                        resources:
                            requests:
                                cpu: 50m
                                memory: 250Mi
                            limits:
                                cpu: 500m
                                memory: 500Mi

                    deployment_strategy:
                        readiness_probe:
                            type: tcp
                            port: 8983
